name: AI Coding Assistant

on:
  issues:
    types: [labeled]

env:
  # Anthropic Model Configuration
  # Available models: claude-sonnet-4-20250514, claude-opus-4-20250514, claude-3-5-sonnet-20241022, etc.
  ANTHROPIC_MODEL: claude-sonnet-4-20250514
  # Maximum tokens for the response
  ANTHROPIC_MAX_TOKENS: 8192

jobs:
  ai-coding:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'ai coding'
    
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create branch name from issue
        id: branch
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          # Sanitize issue title for branch name
          BRANCH_NAME="ai-coding/issue-${ISSUE_NUMBER}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "Branch name: ${BRANCH_NAME}"

      - name: Create and checkout branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b ${{ steps.branch.outputs.branch_name }}

      - name: Get issue details
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use gh CLI to safely get issue details as JSON
          ISSUE_JSON=$(gh issue view ${{ github.event.issue.number }} --json title,body)
          
          # Extract and save to files to avoid shell escaping issues
          echo "$ISSUE_JSON" | jq -r '.title' > /tmp/issue_title.txt
          echo "$ISSUE_JSON" | jq -r '.body' > /tmp/issue_body.txt
          
          echo "Issue title: $(cat /tmp/issue_title.txt)"
          echo "Issue body saved to /tmp/issue_body.txt"

      - name: Call Claude API and apply changes
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read issue details from files (safely escaped)
          ISSUE_TITLE=$(cat /tmp/issue_title.txt)
          ISSUE_BODY=$(cat /tmp/issue_body.txt)
          
          # Get repository structure
          REPO_STRUCTURE=$(find . -type f \( -name "*.ts" -o -name "*.js" -o -name "*.json" -o -name "*.html" -o -name "*.css" -o -name "*.md" \) ! -path "./node_modules/*" ! -path "./.git/*" | head -50 | xargs ls -la 2>/dev/null || echo 'Unable to list files')
          
          # Read key source files for context
          SOURCE_FILES=""
          for file in $(find . -type f \( -name "*.ts" -o -name "*.js" \) ! -path "./node_modules/*" ! -path "./.git/*" | head -10); do
            if [ -f "$file" ]; then
              SOURCE_FILES="${SOURCE_FILES}

          === ${file} ===
          $(cat "$file" | head -200)"
            fi
          done
          
          # Create prompt file to avoid escaping issues
          cat > /tmp/prompt.txt << 'PROMPT_END'
          You are an expert software engineer. Based on the following GitHub issue, provide code changes.

          PROMPT_END
          
          echo "Issue Title: ${ISSUE_TITLE}" >> /tmp/prompt.txt
          echo "" >> /tmp/prompt.txt
          echo "Issue Description:" >> /tmp/prompt.txt
          echo "${ISSUE_BODY}" >> /tmp/prompt.txt
          echo "" >> /tmp/prompt.txt
          echo "Repository structure:" >> /tmp/prompt.txt
          echo "${REPO_STRUCTURE}" >> /tmp/prompt.txt
          echo "" >> /tmp/prompt.txt
          echo "Key source files:" >> /tmp/prompt.txt
          echo "${SOURCE_FILES}" >> /tmp/prompt.txt
          
          cat >> /tmp/prompt.txt << 'PROMPT_END'

          Please analyze the issue and provide:
          1. A summary of what changes are needed
          2. The specific file changes in the following format:

          For each file that needs to be created or modified, use this exact format:

          ===FILE_START===
          PATH: <file_path>
          ACTION: <create|modify>
          ===CONTENT_START===
          <full file content here>
          ===CONTENT_END===

          Make sure to provide complete, working code. Include ALL content for each file, not just the changes.
          PROMPT_END
          
          # Escape the prompt for JSON using jq
          ESCAPED_PROMPT=$(cat /tmp/prompt.txt | jq -Rs .)
          
          # Call Claude API
          RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"${ANTHROPIC_MODEL}\",
              \"max_tokens\": ${ANTHROPIC_MAX_TOKENS},
              \"messages\": [
                {
                  \"role\": \"user\",
                  \"content\": ${ESCAPED_PROMPT}
                }
              ]
            }")
          
          # Check for API errors
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "API Error: $(echo "$RESPONSE" | jq -r '.error.message')"
            exit 1
          fi
          
          # Extract the text content
          CONTENT=$(echo "$RESPONSE" | jq -r '.content[0].text')
          
          # Save response for debugging
          echo "$CONTENT" > /tmp/claude_response.txt
          echo "Claude response saved to /tmp/claude_response.txt"
          
          # Parse and apply file changes
          echo "$CONTENT" | awk '
          BEGIN { in_file=0; in_content=0; path=""; action=""; content="" }
          /===FILE_START===/ { in_file=1; next }
          /^PATH:/ && in_file { gsub(/^PATH: */, ""); path=$0; next }
          /^ACTION:/ && in_file { gsub(/^ACTION: */, ""); action=$0; next }
          /===CONTENT_START===/ { in_content=1; content=""; next }
          /===CONTENT_END===/ { 
            in_content=0; 
            in_file=0;
            if (path != "" && content != "") {
              # Create directory if needed
              dir = path
              gsub(/\/[^\/]*$/, "", dir)
              if (dir != path) {
                system("mkdir -p \"" dir "\"")
              }
              # Write content to file
              print content > path
              close(path)
              print "Written: " path
            }
            path=""; action=""; content=""
            next
          }
          in_content { content = content (content=="" ? "" : "\n") $0 }
          '
          
          # Save summary for PR description (text before first FILE_START)
          SUMMARY=$(echo "$CONTENT" | awk '/===FILE_START===/{exit} {print}')
          
          # Use a delimiter that won't appear in the content
          EOF_MARKER="EOF_$(date +%s)"
          echo "summary<<${EOF_MARKER}" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "${EOF_MARKER}" >> $GITHUB_OUTPUT

      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --porcelain
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_TITLE=$(cat /tmp/issue_title.txt)
          git add -A
          git commit -m "AI: Implement changes for issue #${{ github.event.issue.number }}

          ${ISSUE_TITLE}
          
          Closes #${{ github.event.issue.number }}"

      - name: Push branch
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin ${{ steps.branch.outputs.branch_name }}

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_TITLE=$(cat /tmp/issue_title.txt)
          ISSUE_BODY=$(cat /tmp/issue_body.txt)
          SUMMARY='${{ steps.claude.outputs.summary }}'
          
          # Create PR body file to handle special characters
          cat > /tmp/pr_body.md << PR_BODY_END
          ## AI-Generated Changes for Issue #${{ github.event.issue.number }}
          
          ### Original Issue
          **${ISSUE_TITLE}**
          
          ${ISSUE_BODY}
          
          ---
          
          ### AI Analysis & Changes
          ${SUMMARY}
          
          ---
          
          âš ï¸ **This PR was automatically generated by Claude (${ANTHROPIC_MODEL}). Please review carefully before merging.**
          
          Closes #${{ github.event.issue.number }}
          PR_BODY_END
          
          gh pr create \
            --title "AI: ${ISSUE_TITLE}" \
            --body-file /tmp/pr_body.md \
            --base main \
            --head ${{ steps.branch.outputs.branch_name }}

      - name: Comment on issue (success)
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "ðŸ¤– AI Coding Assistant has created a pull request for this issue.
            
          Branch: \`${{ steps.branch.outputs.branch_name }}\`
          Model: \`${ANTHROPIC_MODEL}\`
            
          Please review the changes and provide feedback!"

      - name: Comment on issue (no changes)
        if: steps.changes.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "ðŸ¤– AI Coding Assistant analyzed this issue but could not determine specific code changes to make.
            
          Model: \`${ANTHROPIC_MODEL}\`
            
          Please provide more details in the issue description, or manually implement the changes.
          
          Debug: Check the workflow run logs for the Claude response."

      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs
          path: |
            /tmp/claude_response.txt
            /tmp/prompt.txt
            /tmp/issue_title.txt
            /tmp/issue_body.txt
          retention-days: 7
